var device = {
    isAndroid: -1 < navigator.userAgent.toLowerCase().indexOf("android"),
    isIos: null != navigator.userAgent.match(/(iPod|iPhone|iPad)/),
    isChrome: /chrom(e|ium)/.test(navigator.userAgent.toLowerCase())
},
    common = {
        qrcodeUrl: (null != document.referrer) ? document.referrer : location.href,
        code: '',
        pushId: '',
        width: '359',
        getUrlQuery: function (o) {
            var n = new RegExp("(^|&)" + o + "=([^&]*)(&|$)", "i"),
                e = window.location.search.substr(1).match(n);
            return null != e ? unescape(e[2]) : null
        },
        getParms: function () {
            common.code = common.getUrlQuery("code") || "";
            common.pushId = common.getUrlQuery("pushId") || "";
            common.width = document.body.clientWidth;
        },
        init: function () {
            common.getParms()
        }
    };

$(function () {
    common.init()
});

var downloadUrlAndroids = [];
var config = {
    downloadUrlAndroid: "",
    downloadUrlIos: "",
    init: function () {
        config.downloadUrlAndroid = '';
        config.downloadUrlIos = 'itms-services://?action=download-manifest&url=https://back-stores.oss-cn-shenzhen.aliyuncs.com/sweet.plist&code=pushId';
        if (!window.downUrls) {
            window.downUrls = [];
        }
        const downUrls_android = downUrls.filter(n => n.os === '0');
        const downUrls_ios = downUrls.filter(n => n.os === '1');
        const ios_url = downUrls_ios[Math.floor(Math.random() * downUrls_ios.length)];

        config.downloadUrlIos = `${ios_url.update_url}${ios_url.update_url.indexOf('?') > -1 ? '&' : '?'}code=${'pushId@' + common.code + "@" + ($('#codeSign').val() || '')}`;
        for (i = 0; i < downUrls_android.length; i++) {
            downloadUrlAndroids[i] = downUrls_android[i].url;
        }
        //config.downloadUrlAndroid = downUrls_android[Math.floor(Math.random() * downUrls_android.length)].url;
    }
};

var objApp = {
    addClipboard: function (o, n) {
        var e = 'pushId@' + common.code + "@" + ($('#codeSign').val() || '');
        $("#bar2").val(e);
        var i = new ClipboardJS(o, {
            container: document.getElementById(n)
        });
        i.on("success", function (e) {
            setTimeout(function () {
                // FIXME: 暂时提示IOS
                e.clearSelection();
            }, 100);
        }), i.on("error", function (o) {
            console.log("亲，此浏览器不支持，请手动复制粘贴吧");
        });
    },
    initClick: function () {
        $(".download-btn").click(function () {
            /**
            if (device.isIos) {
                window.alert("iOS证书签名还未恢复，请先在线观看。等待iOS证书恢复");
                return false;
            }**/
             
            if (device.isIos || device.isAndroid) {
                var os = device.isIos ? "ios" : "Android";
                $.ajax({
                    url: "/down/profile?os=" + os,
                    type: "POST",
                    dataType: "json",
                    success: function (data) { }
                });
                //device.isAndroid ? (location.href = config.downloadUrlAndroid) : 0;
            }
            else {
                $(".dialog-container").removeClass("hide");
            }
        }),

        $(".dialog-container").click(function () {
            $(".dialog-container").addClass("hide")
        });
    },
    mySwipe: function () {
        window.mySwipe = Swipe(document.getElementById("mySwipe"), {
            speed: 400,
            auto: 3e3,
            continuous: !0,
            disableScroll: !1,
            stopPropagation: !1,
            callback: function (o, n) { }, transitionEnd: function (o, n) { }
        });
        //设置图片宽度
        $('#mySwipe').width(common.width);
    },
    makeCode: function () {
        new QRCode(document.getElementById("qrcode"), {
            width: 100,
            height: 100
        }).makeCode(common.qrcodeUrl)
    },
    checkPlatForm: function () {
        $deviceImg = $('.tips img');
        $('#repair').hide();
        $('#setup').hide();
        $('.playload-btn').hide();
        $('.download-container-android').hide();
        if (device.isChrome) {
            $("#slid-logo").css({ "bottom": "1.4rem" });
            $("#slid-text").css({ "bottom": "1.0rem" });
            $(".download-container >.download-btn").css({ "background": "#ff8eaf" });
            $(".download-container >.download-btn").html("立即下载");
            $(".download-container >.playload-btn").css({ "background": "#ff8eaf" });
            $(".download-container >.playload-btn").html("在线观看");
            $('.download-btn').attr('target', "_self");
            objApp.makeCode();
            $("#bar").focus(function () {
                document.activeElement.blur();
            });
            $('.tips').hide();
        }
        if (device.isAndroid) {
            $("#slid-logo").css({ "bottom": ".9rem" });
            $("#slid-text").css({ "bottom": ".2rem" });
            $deviceImg.attr('src', '/public/images/android-f0137a7b0d-1.jpg');
            $(".download-container >.download-btn").css({ "background": "#ff8eaf url(/public/images/android-logo.png) no-repeat 12%", "background-size": "18px" });
            $(".download-container >.download-btn").html("安卓下载");
            $(".download-container >.playload-btn").css({ "background": "#ff8eaf url(/public/images/android-logo.png) no-repeat 14%", "background-size": "18px" });
            $(".download-container >.playload-btn").html("在线观看");
            // $('.download-btn').attr('href', config.downloadUrlAndroid);
            // $('.download-btn').attr('target', "_self"); 
            $('.tips').show();
            $('.download-container-android').show();
            $(".download-container >.download-btn").hide();

            var length = downloadUrlAndroids.length;
            // var length=window.downUrls.length;
            var tLength = Math.floor(length / 2);
            for (i = 0; i < length; i++) {
                if (i > 0 && i % 2 == 0) {
                    $('.download-container-android').append("<div class=\"download-container\" id=\"+temp+\"></div>");
                }
                $('.download-container-android').append("<a class=\"download-btn\" id=\"android-" + i + "\" target=\"_self\" data-clipboard-target=\"#bar2\" data-clipboard-action=\"copy\">安卓下载" + (i + 1) + "</a>");
                $('.download-container-android  >#android-' + i).css({ "background": "#ff8eaf url(/public/images/android-logo.png) no-repeat 12%", "background-size": "18px" });
                $('.download-container-android  >#android-' + i).attr('href', downloadUrlAndroids[i]);
                $('.download-container-android  >#android-' + i).attr('target', "_self");
            }

        }
        if (device.isIos) {
            $("#slid-logo").css({ "bottom": ".9rem" });
            $("#slid-text").css({ "bottom": ".2rem" });
            $deviceImg.attr('src', '/public/images/iphone-f234a44-1.png');
            $(".download-container >.download-btn").css({ "background": "#ff8eaf url(/public/images/iphone-logo.png) no-repeat 16%", "background-size": "16px" });
            $(".download-container >.download-btn").html("iOS稳定版下载");
            $(".download-container >.playload-btn").css({ "background": "#ff8eaf url(/public/images/video_play.png) no-repeat 16%", "background-size": "16px" });
            $(".download-container >.playload-btn").html("在线观看");
            $('.download-btn').attr('href', config.downloadUrlIos);
            $('.download-btn').attr('target', "_blank");
            $('.tips').show();
            $('#repair').show();
            $('#setup').show();
            $('.playload-btn').show();
        }
        if (!device.isChrome && !device.isAndroid && !device.isIos) {
            window.prompt("请更换浏览器访问！");
        }
    },
    init: function () {
        objApp.checkPlatForm();
        objApp.mySwipe();
        if (null != common.pushId && "" != common.pushId.trim() && null != common.code && "12345" != common.code) {
            objApp.addClipboard(".download-btn", "bar2");
        }
        objApp.initClick();
    }
};
$(function () {
    $.get('/ver/last?ts=10086', function (res) {
        window.downUrls = res;
        config.init();
        objApp.init();
    });
});
